---
phase: 03-market-data-service
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/market_data/__init__.py
  - backend/app/market_data/schemas.py
  - backend/app/market_data/models.py
  - backend/app/market_data/providers/__init__.py
  - backend/app/market_data/providers/base.py
  - backend/app/market_data/providers/binance.py
  - backend/app/market_data/providers/twelve_data.py
  - backend/app/market_data/service.py
  - backend/alembic/versions/003_add_ohlcv_cache.py
  - backend/app/config.py
  - backend/requirements.txt
autonomous: true
requirements: [DATA-01, DATA-02, DATA-03]

must_haves:
  truths:
    - "Backend can fetch historical OHLCV candles from Binance REST API for any crypto pair"
    - "Backend can fetch historical OHLCV candles from Twelve Data REST API for forex pairs"
    - "Fetched candles are cached in PostgreSQL ohlcv_cache table to avoid redundant API calls"
    - "Cache-first lookup returns cached data for repeated requests without hitting external APIs"
  artifacts:
    - path: "backend/app/market_data/providers/binance.py"
      provides: "Binance REST and WS client"
      contains: "fetch_klines"
    - path: "backend/app/market_data/providers/twelve_data.py"
      provides: "Twelve Data REST and WS client"
      contains: "fetch_timeseries"
    - path: "backend/app/market_data/models.py"
      provides: "OHLCVCache SQLAlchemy model"
      contains: "class OHLCVCache"
    - path: "backend/app/market_data/service.py"
      provides: "Cache-first historical data fetching"
      contains: "get_historical_candles"
    - path: "backend/alembic/versions/003_add_ohlcv_cache.py"
      provides: "Database migration for ohlcv_cache table"
      contains: "ohlcv_cache"
    - path: "backend/app/market_data/schemas.py"
      provides: "Pydantic models for OHLCV data and WS messages"
      contains: "OHLCVCandle"
  key_links:
    - from: "backend/app/market_data/service.py"
      to: "backend/app/market_data/providers/binance.py"
      via: "BinanceProvider instance for crypto data"
      pattern: "binance.*fetch_klines"
    - from: "backend/app/market_data/service.py"
      to: "backend/app/market_data/providers/twelve_data.py"
      via: "TwelveDataProvider instance for forex data"
      pattern: "twelve_data.*fetch_timeseries"
    - from: "backend/app/market_data/service.py"
      to: "backend/app/market_data/models.py"
      via: "SQLAlchemy queries for cache read/write"
      pattern: "OHLCVCache"

user_setup:
  - service: twelve_data
    why: "Forex market data provider (real-time and historical)"
    env_vars:
      - name: TWELVE_DATA_API_KEY
        source: "Twelve Data Dashboard (https://twelvedata.com/account) -> API Keys section. Free tier: 800 calls/day + 8 WS credits."
    dashboard_config: []
---

<objective>
Build the backend market data foundation: data provider clients for Binance (crypto) and Twelve Data (forex), SQLAlchemy models for OHLCV caching, Alembic migration, Pydantic schemas, and the cache-first service layer.

Purpose: Establish the backend data pipeline that fetches, normalizes, and caches OHLCV candle data from external providers. This foundation enables both real-time streaming (Plan 03) and historical data serving (Plan 03) without coupling those concerns to provider-specific APIs.

Output: Functional provider clients, database cache table, and service layer that can fetch and cache historical candles for any crypto or forex pair.
</objective>

<execution_context>
@/Users/heispv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heispv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-market-data-service/03-RESEARCH.md

# Existing backend patterns
@backend/app/config.py
@backend/app/database.py
@backend/app/main.py
@backend/app/watchlists/models.py
@backend/app/watchlists/service.py
@backend/requirements.txt
@backend/alembic/versions/002_add_watchlists.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data provider clients, Pydantic schemas, and configuration</name>
  <files>
    backend/app/market_data/__init__.py
    backend/app/market_data/schemas.py
    backend/app/market_data/providers/__init__.py
    backend/app/market_data/providers/base.py
    backend/app/market_data/providers/binance.py
    backend/app/market_data/providers/twelve_data.py
    backend/app/config.py
    backend/requirements.txt
  </files>
  <action>
    **1. Add websockets dependency:**
    Add `websockets>=16.0` to `backend/requirements.txt` and install it.

    **2. Add config settings:**
    Add to `backend/app/config.py` (Settings class):
    - `TWELVE_DATA_API_KEY: str = ""` -- empty default for dev mode
    - `BINANCE_REST_URL: str = "https://api.binance.com"` -- base URL for Binance REST
    - `BINANCE_WS_URL: str = "wss://stream.binance.com:9443"` -- base URL for Binance WS
    - `TWELVE_DATA_REST_URL: str = "https://api.twelvedata.com"` -- base URL for Twelve Data REST
    - `TWELVE_DATA_WS_URL: str = "wss://ws.twelvedata.com/v1/quotes/price"` -- WS URL for forex ticks

    **3. Create Pydantic schemas (`backend/app/market_data/schemas.py`):**
    - `OHLCVCandle(BaseModel)`: time (int, Unix seconds), open (float), high (float), low (float), close (float), volume (float)
    - `HistoricalRequest(BaseModel)`: symbol (str), interval (str), start_time (int | None), end_time (int | None), limit (int = 500)
    - `HistoricalResponse(BaseModel)`: symbol (str), interval (str), candles (list[OHLCVCandle])
    - `SubscribeMessage(BaseModel)`: action (Literal["subscribe", "unsubscribe"]), symbol (str), interval (str)
    - `PriceUpdate(BaseModel)`: symbol (str), interval (str), candle (OHLCVCandle), is_closed (bool)
    - `ConnectionStatus(BaseModel)`: status (Literal["connected", "reconnecting", "error"]), message (str | None = None)
    - `AssetClass(str, Enum)`: CRYPTO = "crypto", FOREX = "forex"
    - Helper function `detect_asset_class(symbol: str) -> AssetClass`: returns FOREX if symbol contains "/" (e.g., "EUR/USD"), else CRYPTO
    - Timeframe mapping dicts:
      - `BINANCE_INTERVALS`: maps app timeframes ("1m", "5m", "15m", "30m", "1H", "4H", "1D", "1W", "1M") to Binance format ("1m", "5m", "15m", "30m", "1h", "4h", "1d", "1w", "1M")
      - `TWELVEDATA_INTERVALS`: maps app timeframes to Twelve Data format ("1min", "5min", "15min", "30min", "1h", "4h", "1day", "1week", "1month")

    **4. Create abstract provider base (`backend/app/market_data/providers/base.py`):**
    ```python
    from abc import ABC, abstractmethod
    from app.market_data.schemas import OHLCVCandle

    class MarketDataProvider(ABC):
        @abstractmethod
        async def fetch_historical(
            self, symbol: str, interval: str,
            start_time: int | None = None,
            end_time: int | None = None,
            limit: int = 500,
        ) -> list[OHLCVCandle]:
            """Fetch historical OHLCV candles from the provider."""
            ...

        @abstractmethod
        async def get_available_symbols(self) -> list[str]:
            """Return list of available trading symbols."""
            ...
    ```

    **5. Create Binance provider (`backend/app/market_data/providers/binance.py`):**
    - Class `BinanceProvider(MarketDataProvider)` with httpx.AsyncClient
    - `fetch_historical()`: calls `GET /api/v3/klines` with params {symbol, interval (mapped via BINANCE_INTERVALS), limit (max 1000), startTime (ms), endTime (ms)}. Parse response array: each row is [open_time, open, high, low, close, volume, ...]. Convert open_time from ms to seconds. Return list[OHLCVCandle].
    - `get_available_symbols()`: calls `GET /api/v3/exchangeInfo`, filters for symbols with status "TRADING" and quoteAsset in ("USDT", "BUSD", "BTC"). Returns sorted list of symbol strings.
    - Binance API needs no authentication for market data.
    - Handle HTTP errors gracefully (log and raise).

    **6. Create Twelve Data provider (`backend/app/market_data/providers/twelve_data.py`):**
    - Class `TwelveDataProvider(MarketDataProvider)` with httpx.AsyncClient and api_key param
    - `fetch_historical()`: calls `GET /time_series` with params {symbol, interval (mapped via TWELVEDATA_INTERVALS), outputsize (limit, max 5000), apikey, format: "JSON", order: "asc"}. Optionally add start_date/end_date if start_time/end_time provided (convert Unix seconds to "YYYY-MM-DD HH:MM:SS" or "YYYY-MM-DD" for daily+). Parse response values array. Convert datetime strings to Unix seconds. Handle volume being absent for forex (default 0). Return list[OHLCVCandle].
    - `get_available_symbols()`: return a hardcoded list of ~25 major + minor forex pairs: EUR/USD, GBP/USD, USD/JPY, USD/CHF, AUD/USD, NZD/USD, USD/CAD (majors) + EUR/GBP, EUR/JPY, GBP/JPY, AUD/JPY, EUR/AUD, GBP/AUD, EUR/CAD, GBP/CAD, AUD/NZD, EUR/NZD, CHF/JPY, CAD/JPY, NZD/JPY, EUR/CHF, GBP/CHF, AUD/CAD, NZD/CAD, GBP/NZD (minors).
    - Handle API errors: check response status field, raise on errors.

    **7. Create `__init__.py` files:**
    - `backend/app/market_data/__init__.py`: empty
    - `backend/app/market_data/providers/__init__.py`: export BinanceProvider, TwelveDataProvider
  </action>
  <verify>
    - `cd backend && python -c "from app.market_data.schemas import OHLCVCandle, detect_asset_class; print(detect_asset_class('BTCUSDT'), detect_asset_class('EUR/USD'))"` prints "AssetClass.CRYPTO AssetClass.FOREX"
    - `cd backend && python -c "from app.market_data.providers import BinanceProvider, TwelveDataProvider; print('imports ok')"` succeeds
    - `cd backend && python -c "from app.config import settings; print(settings.BINANCE_REST_URL)"` prints the Binance URL
  </verify>
  <done>
    Provider clients for Binance and Twelve Data can be imported and instantiated. Schemas define all message types. Config includes all provider URLs and API key settings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OHLCV cache model, Alembic migration, and cache-first service layer</name>
  <files>
    backend/app/market_data/models.py
    backend/app/market_data/service.py
    backend/alembic/versions/003_add_ohlcv_cache.py
  </files>
  <action>
    **1. Create SQLAlchemy model (`backend/app/market_data/models.py`):**
    ```python
    from sqlalchemy import Column, String, Float, BigInteger, UniqueConstraint, Index
    from app.database import Base

    class OHLCVCache(Base):
        __tablename__ = "ohlcv_cache"
        __table_args__ = (
            UniqueConstraint("symbol", "interval", "open_time", name="uq_ohlcv_candle"),
            Index("ix_ohlcv_lookup", "symbol", "interval", "open_time"),
        )

        id = Column(BigInteger, primary_key=True, autoincrement=True)
        symbol = Column(String(30), nullable=False)
        interval = Column(String(10), nullable=False)
        provider = Column(String(20), nullable=False)
        open_time = Column(BigInteger, nullable=False)  # Unix timestamp seconds
        open = Column(Float, nullable=False)
        high = Column(Float, nullable=False)
        low = Column(Float, nullable=False)
        close = Column(Float, nullable=False)
        volume = Column(Float, nullable=False, default=0)
    ```

    **2. Create Alembic migration (`backend/alembic/versions/003_add_ohlcv_cache.py`):**
    Follow the pattern from 002_add_watchlists.py. Manual migration file with:
    - `revision = "003"`, `down_revision = "002"`, `branch_labels = None`, `depends_on = None`
    - `upgrade()`: create table "ohlcv_cache" with all columns, unique constraint, and index
    - `downgrade()`: drop table "ohlcv_cache"

    **3. Create market data service (`backend/app/market_data/service.py`):**
    Class `MarketDataService` with:
    - Constructor takes `db: AsyncSession`
    - Provider instances: `_binance = BinanceProvider()`, `_twelve_data = TwelveDataProvider(api_key=settings.TWELVE_DATA_API_KEY)`
    - `_get_provider(symbol: str) -> tuple[MarketDataProvider, str]`: returns (provider, provider_name) based on `detect_asset_class()`. Crypto -> (binance, "binance"), Forex -> (twelve_data, "twelvedata").

    - `async get_historical_candles(symbol, interval, start_time=None, end_time=None, limit=500) -> list[OHLCVCandle]`:
      1. Query ohlcv_cache for matching symbol + interval in [start_time, end_time] range, ordered by open_time ASC
      2. If cached rows cover the requested range (enough candles), convert to OHLCVCandle and return
      3. Otherwise, call provider.fetch_historical() with appropriate params
      4. Bulk insert fetched candles into ohlcv_cache using `INSERT ... ON CONFLICT (symbol, interval, open_time) DO NOTHING` to avoid duplicates
      5. Return the fetched candles

    - `async get_available_symbols(asset_class: AssetClass) -> list[str]`:
      Delegates to appropriate provider's get_available_symbols().

    - Helper `_cache_candles(candles: list[OHLCVCandle], symbol: str, interval: str, provider: str)`:
      Bulk insert using SQLAlchemy Core `insert().on_conflict_do_nothing()` for efficiency. Use `from sqlalchemy.dialects.postgresql import insert as pg_insert`.
  </action>
  <verify>
    - `cd backend && alembic upgrade head` runs without errors (migration applies)
    - `cd backend && python -c "from app.market_data.models import OHLCVCache; print(OHLCVCache.__tablename__)"` prints "ohlcv_cache"
    - `cd backend && python -c "from app.market_data.service import MarketDataService; print('service ok')"` succeeds
  </verify>
  <done>
    OHLCVCache table exists in PostgreSQL with proper indexes. MarketDataService provides cache-first historical data fetching that queries the DB first and falls back to external providers, caching results for future requests.
  </done>
</task>

</tasks>

<verification>
1. All imports resolve: schemas, models, providers, service can all be imported without errors
2. Alembic migration 003 applies cleanly on top of 002
3. Provider classes implement the abstract base interface
4. detect_asset_class correctly routes crypto vs forex symbols
5. Timeframe mapping dicts cover all 9 app timeframes for both providers
</verification>

<success_criteria>
- Binance provider can be instantiated and its fetch_historical method signature is correct
- Twelve Data provider can be instantiated with API key from config
- OHLCVCache table created via Alembic migration with composite unique constraint
- MarketDataService provides cache-first data access pattern
- websockets>=16.0 added to requirements.txt
- Config settings include all provider URLs and TWELVE_DATA_API_KEY
</success_criteria>

<output>
After completion, create `.planning/phases/03-market-data-service/03-01-SUMMARY.md`
</output>
