---
phase: 02-charting-core
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/watchlists/__init__.py
  - backend/app/watchlists/models.py
  - backend/app/watchlists/schemas.py
  - backend/app/watchlists/service.py
  - backend/app/watchlists/router.py
  - backend/app/main.py
  - backend/alembic/versions/002_add_watchlists.py
autonomous: true
requirements: [CHART-10]

must_haves:
  truths:
    - "Watchlist and WatchlistItem tables exist in PostgreSQL with correct schema"
    - "Authenticated user can create, list, and delete watchlists via API"
    - "Authenticated user can add and remove symbols from a watchlist via API"
    - "Authenticated user can reorder items within a watchlist via API"
    - "New users automatically get a default watchlist created on first access"
  artifacts:
    - path: "backend/app/watchlists/models.py"
      provides: "Watchlist and WatchlistItem SQLAlchemy models"
      min_lines: 30
    - path: "backend/app/watchlists/schemas.py"
      provides: "Pydantic request/response schemas for watchlist CRUD"
      min_lines: 40
    - path: "backend/app/watchlists/service.py"
      provides: "WatchlistService with CRUD business logic"
      min_lines: 60
    - path: "backend/app/watchlists/router.py"
      provides: "FastAPI router with 6 watchlist endpoints"
      min_lines: 50
    - path: "backend/alembic/versions/002_add_watchlists.py"
      provides: "Alembic migration for watchlists + watchlist_items tables"
      min_lines: 30
  key_links:
    - from: "backend/app/watchlists/router.py"
      to: "backend/app/watchlists/service.py"
      via: "dependency injection of WatchlistService"
      pattern: "WatchlistService"
    - from: "backend/app/watchlists/router.py"
      to: "backend/app/auth/dependencies.py"
      via: "get_current_user dependency for authentication"
      pattern: "get_current_user"
    - from: "backend/app/main.py"
      to: "backend/app/watchlists/router.py"
      via: "app.include_router(watchlist_router)"
      pattern: "include_router.*watchlist"
---

<objective>
Create the watchlist backend: SQLAlchemy models, Alembic migration, Pydantic schemas, service layer, and FastAPI CRUD endpoints for watchlists and watchlist items.

Purpose: Watchlists are stored server-side so they persist across devices and sessions. This plan builds the complete backend API that the frontend watchlist panel (Plan 05) will consume. Running in parallel with Plan 01 (Wave 1) since it has no frontend dependencies.

Output: 6 new backend files + migration, all watchlist CRUD endpoints functional and authenticated.
</objective>

<execution_context>
@/Users/heispv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heispv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-charting-core/02-RESEARCH.md
@backend/app/main.py
@backend/app/users/router.py
@backend/app/users/service.py
@backend/app/users/schemas.py
@backend/app/auth/models.py
@backend/app/database.py
@backend/alembic/versions/001_initial_schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create watchlist models, schemas, and Alembic migration</name>
  <files>
    backend/app/watchlists/__init__.py
    backend/app/watchlists/models.py
    backend/app/watchlists/schemas.py
    backend/alembic/versions/002_add_watchlists.py
  </files>
  <action>
1. Create `backend/app/watchlists/__init__.py` (empty file)

2. Create `backend/app/watchlists/models.py`:
   - Follow the exact pattern from `backend/app/auth/models.py` for imports and Base class
   - Import Base from `app.common.models` (or wherever the project's declarative base is)
   - `Watchlist` model:
     - `__tablename__ = "watchlists"`
     - `id`: UUID primary key with `server_default=func.gen_random_uuid()`
     - `user_id`: UUID, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, indexed
     - `name`: String(100), nullable=False, server_default="My Watchlist"
     - `created_at`: DateTime(timezone=True), server_default=func.now()
     - `updated_at`: DateTime(timezone=True), server_default=func.now(), onupdate=func.now()
     - `items`: relationship to WatchlistItem, back_populates="watchlist", cascade="all, delete-orphan", order_by="WatchlistItem.sort_order"
   - `WatchlistItem` model:
     - `__tablename__ = "watchlist_items"`
     - `__table_args__`: UniqueConstraint("watchlist_id", "symbol", name="uq_watchlist_symbol")
     - `id`: UUID primary key with `server_default=func.gen_random_uuid()`
     - `watchlist_id`: UUID, ForeignKey("watchlists.id", ondelete="CASCADE"), nullable=False, indexed
     - `symbol`: String(20), nullable=False (e.g., "BTCUSDT")
     - `sort_order`: Integer, nullable=False, server_default="0"
     - `added_at`: DateTime(timezone=True), server_default=func.now()
     - `watchlist`: relationship to Watchlist, back_populates="items"

3. Create `backend/app/watchlists/schemas.py`:
   - Follow the pattern from `backend/app/users/schemas.py`
   - `WatchlistItemResponse`: symbol (str), sort_order (int), added_at (datetime)
   - `WatchlistResponse`: id (UUID), name (str), items (list[WatchlistItemResponse]), created_at (datetime)
   - `WatchlistCreate`: name (str, min 1, max 100, default "My Watchlist")
   - `AddSymbolRequest`: symbol (str, min 1, max 20) -- the symbol to add to a watchlist
   - `ReorderItemsRequest`: items (list of {symbol: str, sort_order: int}) -- new sort order for items

4. Create `backend/alembic/versions/002_add_watchlists.py`:
   - Follow the exact pattern from `001_initial_schema.py` (manual migration, not autogenerated)
   - Revision ID: generate a unique hex string
   - down_revision: set to the revision ID from 001_initial_schema.py (read it from the file)
   - `upgrade()`:
     - Create "watchlists" table with columns matching the model
     - Create "watchlist_items" table with columns matching the model
     - Add indexes: ix_watchlists_user_id, ix_watchlist_items_watchlist_id
     - Add unique constraint: uq_watchlist_symbol (watchlist_id, symbol)
   - `downgrade()`:
     - Drop "watchlist_items" table
     - Drop "watchlists" table
  </action>
  <verify>
    - All files exist: models.py, schemas.py, __init__.py, 002_add_watchlists.py
    - Run migration: `cd backend && alembic upgrade head` -- should create watchlists and watchlist_items tables
    - Verify tables exist: `alembic current` shows revision at 002
    - Python imports work: `python -c "from app.watchlists.models import Watchlist, WatchlistItem; print('OK')"`
    - Schema validation: `python -c "from app.watchlists.schemas import WatchlistResponse, AddSymbolRequest; print('OK')"`
  </verify>
  <done>Watchlists and watchlist_items tables exist in PostgreSQL with correct schema, constraints, and indexes. Models and schemas importable without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create watchlist service and router, mount on FastAPI app</name>
  <files>
    backend/app/watchlists/service.py
    backend/app/watchlists/router.py
    backend/app/main.py
  </files>
  <action>
1. Create `backend/app/watchlists/service.py`:
   - Follow the pattern from `backend/app/users/service.py`
   - `WatchlistService` class with async methods accepting `AsyncSession`:
   - `get_or_create_default(session, user_id)`: Get user's watchlists. If none exist, create a default "My Watchlist" with BTC, ETH, SOL, BNB pre-populated (sort_order 0-3). Return list of watchlists.
   - `list_watchlists(session, user_id)`: Get all watchlists for user with items eager-loaded, ordered by created_at. If no watchlists exist, call get_or_create_default first.
   - `create_watchlist(session, user_id, name)`: Create a new watchlist.
   - `delete_watchlist(session, user_id, watchlist_id)`: Delete a watchlist owned by user. Raise 404 if not found or not owned.
   - `add_symbol(session, user_id, watchlist_id, symbol)`: Add a symbol to a watchlist. Auto-assign sort_order as max(existing) + 1. Raise 409 if symbol already in watchlist. Raise 404 if watchlist not found or not owned.
   - `remove_symbol(session, user_id, watchlist_id, symbol)`: Remove a symbol from a watchlist. Raise 404 if not found.
   - `reorder_items(session, user_id, watchlist_id, items)`: Update sort_order for multiple items in one call. Raise 404 if watchlist not found or not owned.
   - Always verify watchlist ownership by checking `watchlist.user_id == user_id` before mutations.
   - Use `selectinload(Watchlist.items)` for eager loading items.

2. Create `backend/app/watchlists/router.py`:
   - Follow the pattern from `backend/app/users/router.py`
   - Router prefix: `/api/v1/watchlists`, tags: ["watchlists"]
   - All endpoints require authentication via `get_current_user` dependency
   - Endpoints:
     - `GET /api/v1/watchlists` → list_watchlists → returns list[WatchlistResponse]
     - `POST /api/v1/watchlists` → create_watchlist → accepts WatchlistCreate body → returns WatchlistResponse (201)
     - `DELETE /api/v1/watchlists/{watchlist_id}` → delete_watchlist → returns 204
     - `POST /api/v1/watchlists/{watchlist_id}/items` → add_symbol → accepts AddSymbolRequest → returns WatchlistItemResponse (201)
     - `DELETE /api/v1/watchlists/{watchlist_id}/items/{symbol}` → remove_symbol → returns 204
     - `PATCH /api/v1/watchlists/{watchlist_id}/items/reorder` → reorder_items → accepts ReorderItemsRequest → returns WatchlistResponse
   - Use the project's async session dependency pattern (from database.py)
   - Handle exceptions: 404 for not found, 409 for duplicate symbol

3. Update `backend/app/main.py`:
   - Import watchlist router: `from app.watchlists.router import router as watchlist_router`
   - Add: `app.include_router(watchlist_router)` after the existing router includes
  </action>
  <verify>
    - Backend starts: `cd backend && uvicorn app.main:app --reload`
    - API docs visible at http://localhost:8000/docs with watchlist endpoints listed
    - Test with curl (requires auth token):
      - `GET /api/v1/watchlists` → returns default watchlist with BTC, ETH, SOL, BNB items
      - `POST /api/v1/watchlists` with `{"name": "Test"}` → creates new watchlist
      - `POST /api/v1/watchlists/{id}/items` with `{"symbol": "DOTUSDT"}` → adds DOT
      - `DELETE /api/v1/watchlists/{id}/items/DOTUSDT` → removes DOT
      - `DELETE /api/v1/watchlists/{id}` → deletes watchlist
    - Unauthenticated requests return 401/403
    - Adding duplicate symbol returns 409
    - Accessing another user's watchlist returns 404
  </verify>
  <done>All 6 watchlist CRUD endpoints are functional, authenticated, ownership-verified, and accessible via FastAPI. Default watchlist auto-created with 4 crypto symbols for new users.</done>
</task>

</tasks>

<verification>
- Migration creates watchlists + watchlist_items tables with correct schema
- All 6 API endpoints respond correctly to authenticated requests
- Default watchlist with BTC, ETH, SOL, BNB auto-created on first access
- Ownership isolation: users can only see/modify their own watchlists
- Duplicate symbol prevention (409 on conflict)
- Cascade delete: deleting watchlist removes all its items
- Reorder endpoint updates sort_order for all items
</verification>

<success_criteria>
- Watchlist CRUD API is complete and follows existing project backend patterns
- New users get a pre-populated default watchlist automatically
- API endpoints are secured with authentication
- Data persists across server restarts (PostgreSQL)
</success_criteria>

<output>
After completion, create `.planning/phases/02-charting-core/02-04-SUMMARY.md`
</output>
