---
phase: 02-charting-core
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - frontend/src/components/chart/hooks/use-chart.ts
  - frontend/src/components/chart/hooks/use-crosshair.ts
  - frontend/src/components/chart/series-manager.ts
  - frontend/src/components/chart/ohlc-legend.tsx
  - frontend/src/components/chart/chart-container.tsx
  - frontend/src/app/(dashboard)/page.tsx
autonomous: true
requirements: [CHART-01, CHART-03, CHART-04, CHART-06]

must_haves:
  truths:
    - "User can see a candlestick chart rendering on the dashboard with OHLC data and volume bars"
    - "User can zoom in/out with scroll wheel and pan with left-click drag"
    - "User can see crosshair lines spanning full chart with price/time labels at axes"
    - "OHLC legend in top-left updates O/H/L/C values as crosshair moves across candles"
    - "Volume bars appear at the bottom 20% of the chart, colored green/red per candle direction"
  artifacts:
    - path: "frontend/src/components/chart/hooks/use-chart.ts"
      provides: "Chart instance lifecycle management (create, resize, cleanup)"
      min_lines: 50
    - path: "frontend/src/components/chart/hooks/use-crosshair.ts"
      provides: "Crosshair subscription hook providing OHLC values on hover"
      min_lines: 30
    - path: "frontend/src/components/chart/series-manager.ts"
      provides: "Functions to add/remove/switch series by chart type"
      min_lines: 60
    - path: "frontend/src/components/chart/ohlc-legend.tsx"
      provides: "OHLC legend overlay component positioned top-left on chart"
      min_lines: 30
    - path: "frontend/src/components/chart/chart-container.tsx"
      provides: "Main chart wrapper component integrating all chart logic"
      min_lines: 80
  key_links:
    - from: "frontend/src/components/chart/chart-container.tsx"
      to: "frontend/src/stores/chart-store.ts"
      via: "reads activeSymbol, activeTimeframe, chartType, scaleMode"
      pattern: "useChartStore"
    - from: "frontend/src/components/chart/chart-container.tsx"
      to: "frontend/src/lib/mock-data.ts"
      via: "calls getMockDataForSymbol to get chart data"
      pattern: "getMockDataForSymbol"
    - from: "frontend/src/components/chart/series-manager.ts"
      to: "frontend/src/lib/chart-config.ts"
      via: "imports getSeriesOptions for series creation"
      pattern: "getSeriesOptions"
    - from: "frontend/src/components/chart/series-manager.ts"
      to: "frontend/src/lib/heikin-ashi.ts"
      via: "transforms data for Heikin-Ashi chart type"
      pattern: "toHeikinAshi"
    - from: "frontend/src/app/(dashboard)/page.tsx"
      to: "frontend/src/components/chart/chart-container.tsx"
      via: "renders ChartContainer as main dashboard content"
      pattern: "ChartContainer"
---

<objective>
Build the core chart rendering component: React wrapper for lightweight-charts with candlestick/OHLC/line/area series, volume overlay, crosshair subscription, and OHLC legend. Wire it into the dashboard page.

Purpose: This is the visual core of the entire product. After this plan, users see a real financial chart on their dashboard with zoom, pan, crosshair, and volume -- the foundation that toolbar controls (Plan 03) and symbol management (Plan 05) build upon.

Output: Interactive candlestick chart visible on the dashboard at `/`, with OHLC legend, volume bars, crosshair, zoom/pan.
</objective>

<execution_context>
@/Users/heispv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/heispv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-charting-core/02-RESEARCH.md
@.planning/phases/02-charting-core/02-CONTEXT.md
@.planning/phases/02-charting-core/02-01-SUMMARY.md
@frontend/src/app/(dashboard)/layout.tsx
@frontend/src/app/(dashboard)/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chart hooks, series manager, and OHLC legend</name>
  <files>
    frontend/src/components/chart/hooks/use-chart.ts
    frontend/src/components/chart/hooks/use-crosshair.ts
    frontend/src/components/chart/series-manager.ts
    frontend/src/components/chart/ohlc-legend.tsx
  </files>
  <action>
1. Create `frontend/src/components/chart/hooks/use-chart.ts`:
   - `useChart(containerRef: RefObject<HTMLDivElement | null>)` hook that:
     - Creates chart instance via `createChart()` in `useLayoutEffect` (NOT useEffect -- prevents visual flash)
     - Uses `DEFAULT_CHART_OPTIONS` from chart-config.ts for TradingView dark theme
     - Sets up `ResizeObserver` on containerRef to call `chart.applyOptions({ width, height })` on container resize (critical for react-resizable-panels compatibility)
     - Returns `{ chartRef: MutableRefObject<IChartApi | null> }` (chart stored in ref, NOT state)
     - Cleanup: calls `resizeObserver.disconnect()` and `chart.remove()` to prevent memory leaks
     - The chart container div MUST have `position: relative` for the OHLC legend overlay to position correctly
   - Mark with `"use client"` since it uses browser APIs

2. Create `frontend/src/components/chart/hooks/use-crosshair.ts`:
   - `useCrosshair(chartRef: MutableRefObject<IChartApi | null>, mainSeriesRef: MutableRefObject<ISeriesApi<any> | null>)` hook that:
     - Subscribes to `chart.subscribeCrosshairMove()` in useEffect
     - Extracts OHLC data from `param.seriesData.get(mainSeriesRef.current)` (it's a Map, not direct access -- Pitfall 5 from research)
     - Returns `{ legendData: { open, high, low, close, time } | null }` as React state
     - When mouse leaves chart (no param.time), shows the last bar's data (not null)
     - Unsubscribes on cleanup
   - Mark with `"use client"`

3. Create `frontend/src/components/chart/series-manager.ts`:
   - `addMainSeries(chart: IChartApi, chartType: ChartType, data: OHLCVData[]): ISeriesApi<any>`:
     - Uses the SERIES_CONSTRUCTORS map from research Pattern 3: candlestick→CandlestickSeries, heikin-ashi→CandlestickSeries, ohlc→BarSeries, line→LineSeries, area→AreaSeries
     - For heikin-ashi: transforms data via `toHeikinAshi()` before setting
     - For line/area: maps OHLCV data to `{ time, value: close }` format
     - Applies correct series options from `getSeriesOptions(chartType)`
     - Calls `series.setData()` and `chart.timeScale().fitContent()`
     - Returns the created series reference
   - `addVolumeSeries(chart: IChartApi, data: OHLCVData[]): ISeriesApi<'Histogram'>`:
     - Creates HistogramSeries with priceScaleId '' (overlay), priceFormat 'volume'
     - Applies scaleMargins { top: 0.8, bottom: 0 } for bottom 20%
     - Colors each bar green (rgba(38, 166, 154, 0.5)) or red (rgba(239, 83, 80, 0.5)) based on close >= open
     - Returns the volume series reference
   - `switchSeries(chart: IChartApi, currentSeries: ISeriesApi<any> | null, chartType: ChartType, data: OHLCVData[]): ISeriesApi<any>`:
     - Removes old series if exists
     - Calls addMainSeries with new type
     - Does NOT recreate volume series (volume stays constant)

4. Create `frontend/src/components/chart/ohlc-legend.tsx`:
   - React component receiving `{ symbol, open, high, low, close, time, chartType }` props
   - Positioned as absolute overlay in top-left of chart container (top: 12px, left: 12px, z-index: 10)
   - Shows: symbol name (bold), O value, H value, L value, C value
   - Color each value: green (#26a69a) if close >= open, red (#ef5350) if close < open
   - Format prices with appropriate decimal places (use toFixed(2) for most, toFixed(4) for sub-dollar prices)
   - Font: monospace, small size (12-13px), semi-transparent white for labels (O/H/L/C text), colored for values
   - Background: semi-transparent dark (#131722cc) with subtle border radius for readability
   - Must be `"use client"` component
  </action>
  <verify>
    - `npx tsc --noEmit --project frontend/tsconfig.json` passes
    - All 4 files exist in frontend/src/components/chart/
    - use-chart.ts exports useChart hook
    - use-crosshair.ts exports useCrosshair hook
    - series-manager.ts exports addMainSeries, addVolumeSeries, switchSeries
    - ohlc-legend.tsx exports OHLCLegend component
  </verify>
  <done>Chart hooks manage lifecycle and crosshair subscription, series manager handles all 5 chart types with correct data transforms, OHLC legend renders styled overlay</done>
</task>

<task type="auto">
  <name>Task 2: Create ChartContainer component and wire to dashboard page</name>
  <files>
    frontend/src/components/chart/chart-container.tsx
    frontend/src/app/(dashboard)/page.tsx
  </files>
  <action>
1. Create `frontend/src/components/chart/chart-container.tsx`:
   - `"use client"` component (lightweight-charts is ESM-only, client-side only -- Pitfall 6)
   - Reads from chart store: `activeSymbol`, `activeTimeframe`, `chartType`, `scaleMode`
   - Creates containerRef for the chart div
   - Uses `useChart(containerRef)` to get chartRef
   - Manages mainSeriesRef and volumeSeriesRef via useRef
   - Uses `useCrosshair(chartRef, mainSeriesRef)` to get legendData

   - **Data loading effect** (useEffect on [activeSymbol, activeTimeframe]):
     - Calls `getMockDataForSymbol(activeSymbol, activeTimeframe)` to get OHLCV data
     - Stores data in a ref (rawDataRef) for chart type switching without re-generating

   - **Series rendering effect** (useEffect on [data, chartType]):
     - If chart exists and data exists:
       - Remove existing main series and volume series
       - Call `addMainSeries(chart, chartType, data)` → store in mainSeriesRef
       - Call `addVolumeSeries(chart, data)` → store in volumeSeriesRef
       - Update crosshair hook's series reference

   - **Scale mode effect** (useEffect on [scaleMode]):
     - Apply `chart.priceScale('right').applyOptions({ mode: scaleMode === 'logarithmic' ? 1 : 0 })`

   - **Render:** A div with `position: relative`, `width: 100%`, `height: 100%`:
     - Inner div ref={containerRef} filling the parent (this is the canvas container)
     - `<OHLCLegend>` positioned absolutely over the chart
     - The chart div should have a subtle border (1px border-[#2a2e39]) to separate chart background (#131722) from app background (#13131f) -- per Pitfall 7

   - **Keyboard shortcuts** (Claude's discretion):
     - Arrow Left/Right: pan chart
     - Arrow Up/Down: zoom in/out
     - Make chart container focusable (tabIndex=0)
     - Add keyboard event listener in useEffect

2. Update `frontend/src/app/(dashboard)/page.tsx`:
   - Replace the current welcome/placeholder content with `<ChartContainer />`
   - The chart should fill the entire main content area (the center panel of the three-panel layout)
   - Remove the existing welcome message, feature cards, etc.
   - Keep it simple: just render ChartContainer in a full-height container div
   - The parent `<main>` in layout.tsx already has `h-full`, so set the chart wrapper to `h-full w-full`
  </action>
  <verify>
    - `npx tsc --noEmit --project frontend/tsconfig.json` passes
    - `cd frontend && npm run build` succeeds (or at least `npm run dev` shows chart)
    - Navigate to `http://localhost:3000` (after logging in) -- should see a candlestick chart with green/red candles on a #131722 dark background
    - Scroll wheel zooms in/out
    - Left-click drag pans
    - Crosshair lines appear on hover with price/time labels at axes
    - OHLC legend in top-left shows O/H/L/C values updating on crosshair move
    - Volume bars visible at bottom 20% of chart, colored green/red
    - Resizing the sidebar panel causes chart to resize properly (ResizeObserver)
  </verify>
  <done>Dashboard shows interactive candlestick chart with BTC/USDT mock data, volume overlay, crosshair with OHLC legend, zoom/pan, and proper resize handling within the three-panel layout</done>
</task>

</tasks>

<verification>
- Candlestick chart renders on dashboard with TradingView dark background (#131722)
- Green (#26a69a) bullish candles, red (#ef5350) bearish candles, always solid filled
- Volume histogram at bottom 20%, green/red semi-transparent
- Crosshair: full horizontal + vertical dashed lines with price/time labels
- OHLC legend: top-left overlay updating on crosshair move
- Zoom with scroll wheel, pan with left-click drag
- Chart resizes when sidebar panel is dragged
- No memory leaks: chart.remove() called on cleanup, ResizeObserver disconnected
- Arrow key navigation works when chart is focused
</verification>

<success_criteria>
- User sees a professional-quality candlestick chart on the dashboard immediately after login
- Chart interaction (zoom, pan, crosshair) matches TradingView-like behavior
- Volume bars render correctly below price candles
- OHLC legend shows real-time values on hover
- Chart properly responds to panel resize
</success_criteria>

<output>
After completion, create `.planning/phases/02-charting-core/02-02-SUMMARY.md`
</output>
